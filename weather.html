<!DOCTYPE html>
<html>
    <head>
        <title>Weather</title>
        <!--Base on https://www.w3schools.com/html/html_css.asp-->
        <link rel="stylesheet" href="table_style.css">
        <script>
            const apiKey = "79c4fe56c5264162aba15443240309";

            function isZip(my_str) {
                // based on https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp/test
                // str is the str that we recieve from the input
                // regex to test if a US zip code is entered
                const re = /\d{5}/;
                const result = re.test(my_str);
                return result;
            }

            function updateView(){
                // Update everything based on retrieved data, if any
                if (responseData === ""){
                    // if called when there is no response data yet, don't do anything
                    return;
                }
                // Update weather title
                const localeText = "Weather for " + responseData["location"]["name"] + ", " + responseData["location"]["region"];
                document.getElementById("locale").innerHTML = localeText;


                // dictionary to help reduce duplicate code
                const textsToUse = {true:['f',"°F","Celsius"],
                                    false:['c',"°C","Fahrenheit"]};

                //Update text for current temperature
                const tempValue = responseData["current"]["temp_" + textsToUse[temperatureUnitFahrenheit][0]];
                const tempText = tempValue + textsToUse[temperatureUnitFahrenheit][1];
                document.getElementById("temperature").innerHTML = tempText;
                
                //Update the unit switch botton
                const unitChangeButton = document.getElementById("temperature_unit_change");
                unitChangeButton.innerHTML = "Switch to " + textsToUse[temperatureUnitFahrenheit][2];
                document.getElementById("temperature_unit_change").disabled = false;

            }

            async function fetchData(zip) {
                // fetches data from api with fetch API
                const base = "http://api.weatherapi.com/v1/forecast.json?key=";
                const ending = "&days=3&aqi=no&alerts=no";
                const url = base + apiKey + "&q=" + zip + ending;
                const data = await fetch(url)
                // if there is a error log and alert
                    .catch((error) => {console.log(error);
                        alert(error);
                        // revert to previous the valid zip or blank
                        console.log(document.getElementById("zip"))
                        document.getElementById("zip").value = previousZip;
                        // throw error so that the function doesn't keep executing
                        throw error;
                    });
                const json = await data.json();
                return json;
            }

            async function onZipSubmission(){
                // get the zip from input field
                const zip = document.getElementById("zip").value;
                // if it isn't a valid US zip code reject and alert
                if (!isZip(zip)){
                    alert("Invalid US zip code");
                    // revert to previous the valid zip or blank
                    document.getElementById("zip").value = previousZip;
                    return;
                }

                // change to stuff to handle result
                // remember to await! or else the this function will keep running when waiting for alert to be closed
                responseData = await fetchData(zip);
                //Update previousZip after fetching if fetch sucessful
                previousZip = zip;
                console.log(responseData);

                updateView();
            }
        </script>
    </head>
    <body>
        <script>
            // variable to log the previous viable zip
            let previousZip = "";
            // variable to log the response data
            let responseData = ""
            // variable to check the temperature unit
            let temperatureUnitFahrenheit = true;

        </script>
        <p>Enter a zip code</p>
        <input type="text" id="zip"> <button onclick="onZipSubmission()">Get Forecast</button>
        <h1 id="locale">Weather</h1>
        <p>Current Temperature</p>
        <h2 id="temperature"></h2>
        <button id="temperature_unit_change" disabled='disabled'>Switch to Celsius</button>
        <p>3 day Forecast</p>
        <table id="result">
            <tr>
                <th>Day</th>
                <th>High</th>
                <th>Low</th>
                <th>Conditions</th>
            </tr>
            <tr>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            </tr>
            <tr>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            </tr>
            <tr>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            </tr>
        </table>
    </body>
</html>